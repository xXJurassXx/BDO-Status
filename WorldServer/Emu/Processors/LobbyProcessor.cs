using System;
using System.Collections.Generic;
using System.Linq;
using Commons.Enums;
using Commons.Models.Character;
using Commons.UID;
using Commons.Utils;
using FluentNHibernate.Cfg;
using FluentNHibernate.Cfg.Db;
using NHibernate;
using NHibernate.Tool.hbm2ddl;
using NHibernate.Util;
using NLog;
using WorldServer.Configs;
using WorldServer.Emu.Extensions;
using WorldServer.Emu.Interfaces;
using WorldServer.Emu.Models.Creature.Player;
using WorldServer.Emu.Models.MySql.Mapping.WorldMap;
using WorldServer.Emu.Models.Storages;
using WorldServer.Emu.Models.Storages.Abstracts;
using WorldServer.Emu.Networking;
using WorldServer.Emu.Networking.Handling.Frames.Send;
/*
   Author:Sagara
*/
namespace WorldServer.Emu.Processors
{
    public class LobbyProcessor : IProcessor
    {
        /// <summary>
        /// Logger for this class
        /// </summary>
        private static readonly Logger Log = LogManager.GetCurrentClassLogger();

        /// <summary>
        /// Game server dao factory
        /// </summary>
        private static ISessionFactory _gsDbFactory;

        /// <summary>
        /// Character uids generator
        /// </summary>
        private static Int32UidFactory _characterUidsFactory;

        /// <summary>
        /// Items uids generator
        /// </summary>
        private static Int32UidFactory _itemsUidsFactory;

        /// <summary>
        /// Game session uid`s generator
        /// </summary>
        private static Int32UidFactory _gameSessionFactory;

        /// <summary>
        /// Initilize service action
        /// </summary>
        /// <param name="previousInstanceContext"></param>
        public void OnLoad(object previousInstanceContext)
        {
            var config = Fluently.Configure().Database(MySQLConfiguration.Standard.ConnectionString(cs => cs.Is(
                    $"Server={CfgDatabase.Default.GameServerDaoHost};" +
                    $"Database={CfgDatabase.Default.GameServerDaoDatabase};" +
                    $"User={CfgDatabase.Default.GameServerDaoUsername}" +
                    $";Password={CfgDatabase.Default.GameServerDaoPassword};" +
                    "CharSet=utf8"))).Mappings(m =>
                    {
                        m.FluentMappings.AddFromNamespaceOf<CharacterMap>().AddFromNamespaceOf<StorageMap>();
                    });
            
            var export = new SchemaUpdate(config.BuildConfiguration());

            export.Execute(false, true);

            _gsDbFactory = config.BuildSessionFactory();

            var usedIds =  //Get all used character id`s
                _gsDbFactory.OpenSession().CreateSQLQuery("select `c_character_id` from `bd_characters`").List();

            var usedItemUids = _gsDbFactory.OpenSession().CreateSQLQuery("select `i_item_uid` from `bd_items`").List();

            if (usedIds.Any())
            {
                var cId = int.Parse(usedIds[usedIds.Count - 1].ToString());

                _characterUidsFactory = new Int32UidFactory(cId);
            }
            else _characterUidsFactory = new Int32UidFactory();
            
            if (usedItemUids.Any())
            {
                var iUid = int.Parse(usedItemUids[usedItemUids.Count - 1].ToString());

                _itemsUidsFactory = new Int32UidFactory(iUid);
            }
            else _itemsUidsFactory = new Int32UidFactory();

            _gameSessionFactory = new Int32UidFactory();
        }

        public void GetCharacterList(ClientConnection connection)
        {
            using (var db = _gsDbFactory.OpenSession())
            {
                var list = db.QueryOver<CharacterData>().Where(p => p.AccountId == connection.Account.Id).List();
                
                if(list != null)
                    connection.Characters = (List<CharacterData>) list;
                else
                    connection.Characters = new List<CharacterData>();

                foreach (var characterData in connection.Characters)               
                    characterData.EquipmentData = new EquipmentStorage(db.QueryOver<CharacterItem>().Where(i => 
                    i.CharacterId == characterData.CharacterId && i.StorageType == (int)StorageType.Equipment).List().ToDictionary<CharacterItem, short, AStorageItem>(e => 
                    (short)(e.Slot + 1), e => new InventoryItem(e.ItemId, e.Count) {StorageType = (StorageType) e.StorageType}), 48);           
                

                new SpCharacterList(connection.Account, connection.Characters).Send(connection);

                new SpRaw("FEFFFFFFFFFFFFFF00", 0x0c77, false).SendRaw(connection);
            }
        }

        public void CreateCharacterProcess(ClientConnection connection, CharacterData info)
        {
            var characterData = info;

            using (var db = _gsDbFactory.OpenSession())
            {
                if (db.QueryOver<CharacterData>().Where(s => s.CharacterName == info.CharacterName).Take(1).SingleOrDefault() != null)
                {
                    new SpCreateCharacterError().Send(connection);

                    return;
                }
                   
                using (var transaction = db.BeginTransaction())
                {
                    try
                    {
                        characterData.CharacterId = _characterUidsFactory.Next();
                        characterData.Surname = connection.Account.FamilyName;
                        characterData.Level = 1;
                        characterData.CreationDate = DateTime.Now;
                        characterData.CreatedId = 0;//for nhibernate driver
                        characterData.PositionX = -96297;
                        characterData.PositionY = -3872;
                        characterData.PositionZ = 77811;

                        var inventory = InventoryStorage.GetDefault(characterData.ClassType);
                        foreach (var daoItem in inventory.Items.Select(item => new CharacterItem
                        {
                            CharacterId = characterData.CharacterId,
                            ItemId = item.Value.ItemId,
                            ItemUid = _itemsUidsFactory.Next(),
                            Slot = item.Key - 1,
                            Count = item.Value.Count,
                            StorageType = (int) ((InventoryItem)item.Value).StorageType
                        }))                       
                            db.Save(daoItem);
                        
                        db.Save(characterData);

                        connection.Characters.Add(characterData);

                        new SpCreateCharacter(characterData).Send(connection, false);

                        transaction.Commit();
                    }
                    catch (Exception ex)
                    {
                        transaction.Rollback();
                        Log.Error($"Cannot create character\n{ex}");
                    }                   
                }
            }          
        }

        public void DeleteCharacterProcess(ClientConnection connection, long characterId)
        {
            using (var db = _gsDbFactory.OpenSession())
            {
                using (var transaction = db.BeginTransaction())
                {
                    try
                    {
                        var deletionTime = (int)(DateTime.Now.UnixMilliseconds() / 1000);
                        var deleted = connection.Characters.First(s => s.CharacterId == characterId);

                        var equipment = db.QueryOver<CharacterItem>().Where(i => i.CharacterId == deleted.CharacterId).List();
                        for (int i = 0; i < equipment.Count; i++)
                            db.Delete(equipment[i]);
                        
                        db.Delete(deleted);

                        //TODO - Delayed removed task
                        new SpDeleteCharacter(characterId, 1, deletionTime).Send(connection);

                        transaction.Commit();
                    }
                    catch(Exception ex)
                    {
                        transaction.Rollback();
                        Log.Error(ex);
                    }
                }
            }
        }

        public void UpdateCharacter(ClientConnection connection)
        {
            using (var db = _gsDbFactory.OpenSession())
            {
                using (var transaction = db.BeginTransaction())
                {
                    try
                    {
                        var equipment = db.QueryOver<CharacterItem>().Where(i => i.CharacterId == connection.ActivePlayer.DatabaseCharacterData.CharacterId).List();
                        for (int i = 0; i < equipment.Count; i++)
                            db.Delete(equipment[i]);

                        /*Update inventory items*/
                        foreach (var daoItem in connection.ActivePlayer.Inventory.Items.Select(item => new CharacterItem
                        {
                            CharacterId = connection.ActivePlayer.DatabaseCharacterData.CharacterId,
                            ItemId = item.Value.ItemId,
                            ItemUid = _itemsUidsFactory.Next(),
                            Slot = item.Key - 1,
                            Count = item.Value.Count,
                            StorageType = (int)((InventoryItem)item.Value).StorageType
                        })) db.Save(daoItem);

                        /*Update equipment items*/
                        foreach (var daoItem in connection.ActivePlayer.Equipment.Items.Select(item => new CharacterItem
                        {
                            CharacterId = connection.ActivePlayer.DatabaseCharacterData.CharacterId,
                            ItemId = item.Value.ItemId,
                            ItemUid = _itemsUidsFactory.Next(),
                            Slot = item.Key - 1,
                            Count = item.Value.Count,
                            StorageType = (int)((InventoryItem)item.Value).StorageType
                        }))db.Save(daoItem);

                        db.Update(connection.ActivePlayer.DatabaseCharacterData);

                        transaction.Commit();
                    }
                    catch (Exception ex)
                    {
                        Log.Error($"Cannot update player id:{connection.ActivePlayer.DatabaseCharacterData.CharacterId} exception:\n{ex}");

                        transaction.Rollback();
                    }
                }
            }
        }

        public void PrepareForEnterOnWorld(ClientConnection connection, long characterId)
        {
            var player = new Player(connection, connection.Characters.First(s => s.CharacterId == characterId))
            {
                GameSessionId = _gameSessionFactory.Next(),
            };

            using (var db = _gsDbFactory.OpenSession())
            {
                var daoItems = db.QueryOver<CharacterItem>().Where(i => i.CharacterId == characterId).List();
                var items = new List<CharacterItem>();
                var equipItems = new List<CharacterItem>();

                foreach (var it in daoItems)
                {
                    if (it.StorageType == (int) StorageType.Equipment)
                        equipItems.Add(it);
                    if (it.StorageType == (int) StorageType.Inventory)
                        items.Add(it);
                }
                
                player.Inventory = new InventoryStorage(items.ToDictionary<CharacterItem, short, AStorageItem>(e => (short)(e.Slot + 1), e => new InventoryItem(e.ItemId, e.Count) {StorageType = (StorageType) e.StorageType}), 48);
                player.Equipment = new EquipmentStorage(equipItems.ToDictionary<CharacterItem, short, AStorageItem>(e => (short)(e.Slot + 1), e => new InventoryItem(e.ItemId, e.Count) {StorageType = (StorageType) e.StorageType}), 48);
            }

            connection.ActivePlayer = player;
            connection.ActivePlayer.PlayerActions += (action, parameters) =>
            {
                switch (action)
                {
                    case Player.PlayerAction.Logout:
                        if (connection.ActivePlayer != null)
                        {
                            UpdateCharacter(connection);
                            _gameSessionFactory.ReleaseUniqueInt(connection.ActivePlayer.GameSessionId);
                        }
                        break;                       
                }
            };

            var sessionId = BitConverter.GetBytes(connection.ActivePlayer.GameSessionId).ToHex();

            new SpRaw("000000000000000000000000", 0x0cec).SendRaw(connection);
            new SpRaw("2601620010FC266F38020100000000000000630010FC266F38020100000000000000680010FC266F380201000000000000006E0010FC266F38020100000000000000720010FC266F38020100000000000000850010FC266F38020100000001000000960010FC266F380201000000000000009E0010FC266F38020100000000000000AD0010FC266F38020100000000000000AE0010FC266F38020100000000000000AF0010FC266F38020100000000000000B00010FC266F38020100000000000000B20010FC266F38020100000000000000B30010FC266F38020400000001000000BA0010FC266F38020100000000000000C30010FC266F38020100000000000000C80010FC266F38020100000000000000CA0010FC266F38020100000000000000CF0010FC266F38020100000000000000D70010FC266F38020100000000000000DB0010FC266F38020100000001000000DD0010FC266F38020100000001000000E20010FC266F38020100000000000000E30010FC266F38020100000001000000E50010FC266F38020100000000000000E70010FC266F38020100000000000000E80010FC266F38020100000000000000EA0010FC266F38020100000000000000EC0010FC266F38020100000000000000EE0010FC266F38020100000000000000F80010FC266F38020100000001000000FB0010FC266F38020100000000000000100110FC266F38020100000000000000160110FC266F38020100000000000000180110FC266F38020100000001000000190110FC266F380201000000000000001A0110FC266F380201000000000000001E0110FC266F38020100000000000000250110FC266F38020100000001000000280110FC266F380201000000000000002D0110FC266F38020100000000000000330110FC266F38020100000000000000340110FC266F38020100000000000000350110FC266F38020100000000000000370110FC266F38020100000000000000390110FC266F380201000000000000003B0110FC266F380201000000000000003D0110FC266F38020100000000000000440110FC266F380201000000000000004F0110FC266F38020100000000000000560110FC266F380201000000000000005B0110FC266F380201000000010000005C0110FC266F380201000000000000005E0110FC266F38020100000001000000600110FC266F38020100000001000000640110FC266F38020100000000000000650110FC266F38020100000000000000680110FC266F380201000000000000006B0110FC266F380201000000000000006C0110FC266F38020100000001000000710110FC266F38020100000000000000730110FC266F38020100000000000000740110FC266F38020100000000000000770110FC266F38020100000000000000790110FC266F38020100000000000000800110FC266F38020200000001000000840110FC266F38020100000000000000900110FC266F38020100000000000000950110FC266F38020100000000000000960110FC266F380201000000000000009D0110FC266F38020100000001000000A00110FC266F38020100000000000000AC0110FC266F38020100000000000000AE0110FC266F38020100000000000000AF0110FC266F38020100000000000000C00110FC266F38020100000000000000C30110FC266F38020100000000000000C40110FC266F38020100000000000000C70110FC266F38020E00000001000000C90110FC266F38022600000004000000CD0110FC266F38020300000000000000D00110FC266F38020100000000000000D10110FC266F38020100000000000000DA0110FC266F38020100000000000000E60110FC266F38020100000001000000F00110FC266F38020100000000000000F60110FC266F38020100000000000000FC0110FC266F38020100000000000000FD0110FC266F38020100000000000000010210FC266F380201000000000000000D0210FC266F38020100000000000000140210FC266F38020600000000000000190210FC266F380201000000000000001A0210FC266F380201000000000000001B0210FC266F380201000000000000001C0210FC266F380201000000000000001E0210FC266F38020100000000000000200210FC266F38020100000000000000230210FC266F38020100000000000000250210FC266F38021A00000015000000260210FC266F380205000000000000002C0210FC266F38020100000001000000350210FC266F38020100000000000000470210FC266F3802C504000006000000490210FC266F380201000000000000004A0210FC266F380201000000000000004B0210FC266F380201000000000000004D0210FC266F38020100000000000000520210FC266F38020100000000000000580210FC266F38020100000001000000590210FC266F380201000000000000005D0210FC266F38020100000001000000620210FC266F38020100000000000000640210FC266F38020100000000000000650210FC266F38020100000000000000670210FC266F38020100000001000000680210FC266F380201000000000000006A0210FC266F380201000000000000006F0210FC266F38020100000000000000770210FC266F38020D000000010000007B0210FC266F380201000000000000007E0210FC266F38020200000001000000820210FC266F38020100000001000000870210FC266F38020100000000000000880210FC266F38020100000000000000960210FC266F38021B00000002000000970210FC266F38020100000000000000A20210FC266F38020100000000000000A30210FC266F38020100000000000000AA0210FC266F38020100000000000000B60210FC266F38020100000000000000BD0210FC266F38020100000000000000BE0210FC266F38020100000000000000C40210FC266F38020100000000000000C50210FC266F38020100000001000000C70210FC266F38020100000000000000D00210FC266F38020100000001000000D40210FC266F38020100000001000000D60210FC266F38020100000000000000DA0210FC266F38020100000000000000ED0210FC266F38020100000000000000EF0210FC266F38020100000001000000F00210FC266F38020100000000000000F30210FC266F38020100000000000000000310FC266F38020100000000000000010310FC266F38020100000000000000020310FC266F38020100000000000000060310FC266F38020100000000000000080310FC266F380201000000000000000B0310FC266F380210000000010000000C0310FC266F380235000000010000000D0310FC266F380201000000000000000E0310FC266F380201000000010000001C0310FC266F38020100000001000000200310FC266F38020100000000000000250310FC266F38020100000000000000260310FC266F380201000000000000002D0310FC266F38020100000000000000310310FC266F38020100000000000000390310FC266F380201000000000000003B0310FC266F38020100000000000000420310FC266F38020500000001000000430310FC266F38020100000000000000460310FC266F38020100000000000000470310FC266F38020100000000000000490310FC266F380201000000000000004B0310FC266F38020100000000000000520310FC266F38020600000000000000530310FC266F38020100000000000000560310FC266F380201000000000000005D0310FC266F38020100000000000000600310FC266F38020100000000000000630310FC266F38020100000000000000660310FC266F38020100000000000000670310FC266F380201000000000000006B0310FC266F380201000000000000006D0310FC266F380201000000010000006E0310FC266F380201000000000000006F0310FC266F38020100000000000000720310FC266F38020100000000000000730310FC266F38020100000000000000740310FC266F38020100000000000000770310FC266F38020100000000000000780310FC266F38020200000001000000790310FC266F380201000000000000007A0310FC266F38020300000000000000810310FC266F38020100000000000000840310FC266F380201000000000000008A0310FC266F380201000000000000008E0310FC266F38020100000000000000A20310FC266F38020100000000000000A70310FC266F38020200000000000000AE0310FC266F38020200000001000000AF0310FC266F38020100000000000000B00310FC266F38020100000000000000B20310FC266F38020100000001000000BC0310FC266F38020100000000000000C10310FC266F38020100000000000000C30310FC266F38020100000000000000C70310FC266F38020100000000000000C90310FC266F38020100000000000000D00310FC266F38020100000000000000D10310FC266F38020200000001000000D50310FC266F38020100000000000000D90310FC266F38020100000000000000E10310FC266F38020100000000000000E40310FC266F38020100000000000000E60310FC266F38020100000000000000EC0310FC266F38020100000000000000EE0310FC266F38020100000000000000F20310FC266F38020100000000000000F30310FC266F38020100000000000000F40310FC266F38020100000000000000F60310FC266F38020100000000000000F80310FC266F38020100000000000000010410FC266F380201000000000000000E0410FC266F38020100000001000000130410FC266F38020100000001000000150410FC266F38020100000000000000180410FC266F380224000000040000001D0410FC266F380201000000000000001F0410FC266F38020100000000000000210410FC266F38020100000000000000280410FC266F38020100000000000000320410FC266F38020100000000000000350410FC266F38020100000000000000380410FC266F38028C000000050000003D0410FC266F380201000000000000003E0410FC266F38020100000000000000400410FC266F38020100000000000000981BC9ED85BE3F0101000000000000009A1BC9ED85BE3F0108000000000000009B1BC9ED85BE3F010100000000000000A21BC9ED85BE3F010100000000000000AC1BC9ED85BE3F010100000000000000AD1BC9ED85BE3F010400000000000000AE1BC9ED85BE3F010100000000000000B11BC9ED85BE3F010100000000000000B61BC9ED85BE3F010100000000000000BA1BC9ED85BE3F010700000000000000C41BC9ED85BE3F010900000000000000C51BC9ED85BE3F010100000000000000C61BC9ED85BE3F010100000000000000C71BC9ED85BE3F010100000000000000C81BC9ED85BE3F010100000000000000CA1BC9ED85BE3F010200000000000000CD1BC9ED85BE3F010100000000000000D81BC9ED85BE3F010100000000000000DB1BC9ED85BE3F010100000000000000E21BC9ED85BE3F010C00000000000000E71BC9ED85BE3F010100000000000000ED1BC9ED85BE3F010400000000000000EE1BC9ED85BE3F010100000000000000F01BC9ED85BE3F010100000000000000F31BC9ED85BE3F010100000000000000F41BC9ED85BE3F010400000000000000F91BC9ED85BE3F010300000000000000FD1BC9ED85BE3F010100000000000000051CC9ED85BE3F010200000000000000081CC9ED85BE3F010100000000000000091CC9ED85BE3F010C000000000000000D1CC9ED85BE3F0101000000000000000E1CC9ED85BE3F010200000000000000121CC9ED85BE3F010300000000000000171CC9ED85BE3F0101000000000000001A1CC9ED85BE3F0101000000000000001B1CC9ED85BE3F0101000000000000001C1CC9ED85BE3F0101000000000000001D1CC9ED85BE3F0102000000000000001E1CC9ED85BE3F010100000000000000261CC9ED85BE3F010100000000000000291CC9ED85BE3F010100000000000000301CC9ED85BE3F010100000000000000331CC9ED85BE3F010200000000000000341CC9ED85BE3F010100000000000000361CC9ED85BE3F010200000000000000381CC9ED85BE3F0102000000000000003A1CC9ED85BE3F0101000000000000003B1CC9ED85BE3F0105000000000000003C1CC9ED85BE3F010200000000000000411CC9ED85BE3F010100000000000000421CC9ED85BE3F010100000000000000431CC9ED85BE3F010100000000000000451CC9ED85BE3F0101000000000000004A1CC9ED85BE3F0102000000000000004B1CC9ED85BE3F0103000000000000004D1CC9ED85BE3F0101000000000000004F1CC9ED85BE3F010100000000000000521CC9ED85BE3F010100000000000000531CC9ED85BE3F010100000000000000551CC9ED85BE3F010200000000000000561CC9ED85BE3F010100000000000000571CC9ED85BE3F010100000000000000581CC9ED85BE3F010100000000000000", 0x10ab).SendRaw(connection);
            new SpRaw("5F97875600000000000000005965B5B900000000000000000000000000", 0x0d4e).SendRaw(connection);

            new SpSpawnCharacter(connection.ActivePlayer).Send(connection);

            #region Weather, Time
            new SpRaw("", 0x0cfb).SendRaw(connection);
            new SpRaw("010000", 0x115a).SendRaw(connection);
            new SpRaw("010089060001008806000100EA040001008A020001008A06000100F70500010037060001008706000100F405000100340600010003060001007E02000100BE04000100EB050001007F02000100FF05000100F205000100DD00000100DD05000100DE00000100DE05000100B1020001000D060001008D020001008C02000100CF000001008F020001000E060001008E02000100CB000001008B02000100860200010081020001008002000100900200010093020001005C00000100DC0000010058000001001906000100F305000100DF050001002406000100E0050001003A06000100F805000100510600", 0x0d12).SendRaw(connection);
            new SpRaw("0000", 0x1134).SendRaw(connection);
            new SpRaw("14", 0x0c46).SendRaw(connection); //inventory slot count?
            #endregion

            new SpInventory(connection.ActivePlayer).Send(connection);

            new SpRaw("0101" +
                      sessionId + //game session
                      "0000000000000000000000000000", 0x0bf1).SendRaw(connection);

            new SpCharacterEquipment(connection.ActivePlayer).Send(connection);

            #region Chat, Chat tabs, Everything chat related
            new SpRaw("00010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("01010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("02010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("03010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("04010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("05010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("06010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("07010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("08010000000000000000000000", 0x1082).SendRaw(connection);
            new SpRaw("015F978756000000000353BC8E07000000001E59752F02000000C6BB8E2902000000BC670FAD01000000AE09A90B000000005EF3105200000000B6539D9700000000A9C1B6E9000000003CFDF51E00000000FEF6C62D0100000059091C1101000000C960E9E401000000476244C801000000664134FB0100000075873316020000009F2F5A360100000094BA5DEF000000006C0359A6000000008C97EA8100000000661CBEC100000000", 0x0cdc).SendRaw(connection);
            new SpRaw("00000000040000007C0100000000000001000000010000000000000000000000020000000100000000000000000000004B000000000000000000000000000000", 0x1084).SendRaw(connection);
            #endregion
        }

        public void EnterOnWorldProcess(ClientConnection connection, int gameSession)
        {
            var sessionId = BitConverter.GetBytes(connection.ActivePlayer.GameSessionId).ToHex();
            var uid = BitConverter.GetBytes(connection.ActivePlayer.Uid).ToHex();

            new SpUpdateLevel(connection.ActivePlayer).Send(connection);

            #region I have no idea what these 2 do, but they are used.
            new SpRaw(sessionId + //game session
                      "9C8524000000000000007A440000000000000000000000000000400D0300400D0300400D0300400D0300", 0x0f73).SendRaw(connection);
            new SpRaw("01" +
                      sessionId + //game session
                      "0000FC410000FC4100002841000028410000284200000000000000009C852400000000000100000000008040140000000000000040420F00000000000000000000000000", 0x0f76).SendRaw(connection);
            #endregion

            new SpRaw("000000000000000000000000", 0x0f78).SendRaw(connection);
            new SpRaw("020008000B00000E0000", 0x0f7b).SendRaw(connection);
            new SpRaw("0000000000000000", 0x0f7f).SendRaw(connection);
            new SpRaw("02E8030000C8000000E8030000", 0x0eb7).SendRaw(connection);
            new SpRaw(sessionId + //game session
                      "0500000005000000050000000A0000000A0000000A0000000000000005000000000000000500000000000000050000000000000005000000", 0x0f75).SendRaw(connection);

            #region Skills, Crafting
            new SpRaw(uid + //uid
                      "302C322C36383631363139332C302C302C303B312C322C32343930333638312C302C302C303B322C312C3530322C302C302C35303B332C322C36393230363031372C302C302C303B342C322C38393036333432352C302C302C303B352C312C3530332C302C302C35333B362C322C39323533363833332C302C302C303B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", 0x0d27).SendRaw(connection);
            #endregion

            return;
            /*TODO*/

            #region Loading Map screen
            
            new SpRaw("05009B9E010000009D9E01000000FE9E01000000129F01000000149F01000000", 0x0ea2).SendRaw(connection);            
            new SpRaw("000006006D000000000000000000000000003D00000001000000000000000000C90000000000000000000000000041000000000000000000000000004200000000000000000000000000CC00000000000000000000000000", 0x0e7d).SendRaw(connection);
            new SpRaw("0000", 0x0e80).SendRaw(connection);
            new SpRaw("0000", 0x0ea7).SendRaw(connection);
            new SpRaw("0000", 0x0ea7).SendRaw(connection);
            new SpRaw("0000", 0x0ea7).SendRaw(connection);
            new SpRaw("000000000300000000000000", 0x0d26).SendRaw(connection);
            new SpRaw("0000", 0x0e6e).SendRaw(connection);
            new SpRaw("0000", 0x0e6f).SendRaw(connection);
                     
            new SpRaw("0E00A20F0000010000001200000001000000DD0B00000100000085010000010000008701000001000000DC02000001000000D80B000001000000A30F000002000000DB0B000004000000A40F000002000000A50F000001000000A70F000001000000A80F000001000000A90F000001000000", 0x0c6c).SendRaw(connection);
            new SpRaw("1E001E00", 0x0c6b).SendRaw(connection);
            new SpRaw("0000", 0x0fc4).SendRaw(connection);
            new SpRaw("01000000", 0x0c29).SendRaw(connection);
            new SpRaw("003C55120000000000000000000000000000000000000000000000000000000000000000000000000000000000000100550D0000000010E132201700000059E1", 0x0d2c).SendRaw(connection);
            new SpRaw("000450120000000000000000000000000000000000000000000000000000000000000000000000000000000000000100460D0000000010E1322017000000FEFF", 0x0d2c).SendRaw(connection);
            #endregion

            #region Spawn my player
            new SpRaw("0100000000FCFFFF000000000000000000000000020004541800B5BEBEC736D969C5677F9747417B7A3F000000000079533E1D0000000000254300002543F5FCFFFFFFFFFFFFF5FCFFFFFFFFFFFFFF3B3B80960000000000000000000000000000000003000000000000000000000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFF000000000000000000000000000000000000000000000000000000000000FEFFFFFF00000000000000000000000000000000000000000000000000000000FFFF000000000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000FFFF00000000000000000000000000000000000000000000000000000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF00000000000000000000000000000000000000000000000000000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F26498C828730000000000000100000042C6C16FF2862300010000000100000002000000010000000000000000000000000000004138000000FCFFFF25000000000000000000000000053401000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FCFFFF0107000000000000000300000000000000000040085F0CC16FF286230000000000E86C00000000000000000000000000000000000000F8FFFF0000000000000000000000000200000000000000000000000000" +
                      sessionId +  //game session
                      "8014BCC7000072C580F99747046788BE0000000080BF763F030000000000474300004743ABE7FFFFFFFFFFFFABE7FFFFFFFFFFFF00946DE4950000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFF0000000000000000000000000000000000000000000000000000000000BE00000000000000000000000000000000000000000000000000000000000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D30900000000000001000000" +
                      uid + //uid
                      "01000000010000000200000001000000000000000000000000000000A128000000FCFFFF2500000000000000000000000005E800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FCFFFF010800000000000000030000000000000000000000000000000000000000000000A05100000000000000000000000000000000000000F8FFFF0000000000000000000000000200000000000000000000000000", 0x0bb9).SendRaw(connection);
            new SpRaw("0100000100FCFFFF0000000000000000000000000100" +
                      sessionId + //game session
                      "8014BCC7000072C580F99747046788BE0000000080BF763F030000000000474300004743ABE7FFFFFFFFFFFFABE7FFFFFFFFFFFFFD946DE4950000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F100000000000000000000000000000000000000000000000000000000000050390000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFF0285000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000006359000000000000000000000000000000000000000000000000000000000000B8F1000000000000000000000000000000000000000000000000000000000000C06C0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000FEFF000000000000000000000000000000000000000000000000000000000000A871000000000000000000000000000000000000000000000000000000000000B0FA0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E0F1000000000000000000000000000000000000000000000000000000000000387E00000000000000000000000000000000000000000000000000000000FFFF00000000000000000000000000000000000000000000000000000000000000002050000000000000000000000000000000000000000000000000000000000000E0F400000000000000000000000000000000000000000000000000000000000038E2000000000000000000000000000000000000000000000000000000000000AF5C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038F300000000000000000000000000000000000000000000000000000000000000EAD30900000000000001000000" +
                      uid + //uid
                      "01000000010000000200000001000000000000000000000000000000A128000000FCFFFF2500000000000000000000000005E800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FCFFFF010800000000000000030000000000000000000000000000000000000000000000A05100000000000000000000000000000000000000FCFFFF0000000000000000000000000200000000000000000000000000", 0x0bb9).SendRaw(connection);
            new SpRaw(sessionId + //game session, UNKNOWN! Only 2 packets used for spawn which are above.
                      "302622000000000000007A440000000000000000000000000000400D0300400D0300400D0300400D0300", 0x0f59).SendRaw(connection);
            #endregion


            #region Mana is 0x0f52 and 0x0f51 unk
            new SpRaw("ABE7FFFFFFFFFFFFABE7FFFFFFFFFFFF" +
                      sessionId +//game session
                      "000000000000000000004F4300004F4300004F4300FCFFFF", 0x0f51).SendRaw(connection);

            new SpRaw("ABE7FFFFFFFFFFFFABE7FFFFFFFFFFFF" +
                      sessionId + //game session
                      "0000000000000000B1000000B1000000B100000000", 0x0f52).SendRaw(connection);
            #endregion

            new SpCharacterCustimozationData(connection.ActivePlayer).Send(connection);

            Core.Act(s =>
            {
                s.CharacterProcessor.EndLoad(connection);
                s.WorldProcessor.EndLoad(connection);
            });
        }

        public object OnUnload()
        {
            return null;
        }
    }
}
